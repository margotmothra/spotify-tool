<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Creator - Andy Shauf</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #191414;
            color: #fff;
        }
        .container {
            background-color: #282828;
            padding: 30px;
            border-radius: 8px;
            position: relative;
        }
        .logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .logo-container img {
            height: 40px;
            width: auto;
        }
        button {
            background-color: #1db954;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 24px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #1ed760;
        }
        button:disabled {
            background-color: #535353;
            cursor: not-allowed;
        }
        #loginBtn.logged-in {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 20px 6px 6px;
            background-color: #282828;
            cursor: default;
        }
        #loginBtn.logged-in:hover {
            background-color: #282828;
        }
        .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #333;
        }
        .success { color: #1db954; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #333;
            border: 1px solid #535353;
            color: #fff;
            border-radius: 4px;
            font-family: Arial, sans-serif;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="spotify-logo.png" alt="Spotify">
        </div>
        <h1>Spotify Playlist Creator</h1>
        <p>Create a complete artist discography playlist with smart deduplication</p>
        
        <label for="artistName">Artist Names (one per line or comma-separated):</label>
        <textarea id="artistName" placeholder="Enter artist names, e.g.:&#10;Andy Shauf&#10;Sufjan Stevens&#10;or: Andy Shauf, Sufjan Stevens">Andy Shauf</textarea>
        
        <label for="playlistName">Playlist Name:</label>
        <input type="text" id="playlistName" value="" placeholder="Auto-filled from artist names">
        
        <div style="margin-top: 20px;">
            <button id="loginBtn" onclick="login()">Login with Spotify</button>
            <button id="createBtn" onclick="createPlaylist()" disabled>Create Playlist</button>
        </div>
        
        <div id="status"></div>
    </div>

    <script src="config.js"></script>
    <script>
        // Load Spotify credentials from config file
        const CLIENT_ID = SPOTIFY_CONFIG.CLIENT_ID;
        const CLIENT_SECRET = SPOTIFY_CONFIG.CLIENT_SECRET;
        const REDIRECT_URI = SPOTIFY_CONFIG.REDIRECT_URI;

        let accessToken = null;

        // Check if we're returning from OAuth
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                getAccessToken(code);
            }

            // Auto-fill playlist name based on artist names
            const artistInput = document.getElementById('artistName');
            const playlistInput = document.getElementById('playlistName');

            function updatePlaylistName() {
                const artistNames = artistInput.value
                    .split(/[\n,]+/)
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                if (artistNames.length > 0) {
                    const playlistName = artistNames.join(' + ') + ' - Complete';
                    playlistInput.value = playlistName;
                }
            }

            artistInput.addEventListener('input', updatePlaylistName);

            // Trigger initial auto-fill if there's a default value
            updatePlaylistName();
        };

        function login() {
            const scopes = 'playlist-modify-private playlist-modify-public';
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = authUrl;
        }

        async function getAccessToken(code) {
            updateStatus('Getting access token...', 'info');
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI
                    })
                });
                
                const data = await response.json();
                accessToken = data.access_token;

                // Fetch user profile
                const user = await fetchWebApi('v1/me', 'GET');

                // Update login button with user info
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.classList.add('logged-in');

                const profileImage = user.images && user.images.length > 0
                    ? user.images[0].url
                    : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"%3E%3Ccircle cx="16" cy="16" r="16" fill="%23535353"/%3E%3Cpath d="M16 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 10c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z" fill="%23fff"/%3E%3C/svg%3E';

                loginBtn.innerHTML = `<img src="${profileImage}" alt="Profile" class="profile-pic"><span>Logged in as ${user.display_name}</span>`;

                document.getElementById('createBtn').disabled = false;
                updateStatus('✅ Logged in successfully! Ready to create playlist.', 'success');

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                updateStatus('❌ Error getting access token: ' + error.message, 'error');
            }
        }

        async function fetchWebApi(endpoint, method, body) {
            const res = await fetch(`https://api.spotify.com/${endpoint}`, {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                },
                method,
                body: JSON.stringify(body)
            });
            return await res.json();
        }

        async function searchArtist(artistName) {
            const data = await fetchWebApi(
                `v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=10`,
                'GET'
            );

            if (!data.artists.items || data.artists.items.length === 0) {
                return null;
            }

            // Try to find exact match first (case-insensitive)
            const exactMatch = data.artists.items.find(
                artist => artist.name.toLowerCase() === artistName.toLowerCase()
            );

            // Return exact match if found, otherwise return first result
            return exactMatch || data.artists.items[0];
        }

        async function getArtistAlbums(artistId) {
            let albums = [];
            let offset = 0;
            const limit = 50;
            
            while (true) {
                const data = await fetchWebApi(
                    `v1/artists/${artistId}/albums?include_groups=album,single,compilation&limit=${limit}&offset=${offset}`,
                    'GET'
                );
                albums.push(...data.items);
                
                if (data.items.length < limit) break;
                offset += limit;
            }
            
            return albums;
        }

        async function getAlbumTracks(albumId) {
            let tracks = [];
            let offset = 0;
            const limit = 50;
            
            while (true) {
                const data = await fetchWebApi(
                    `v1/albums/${albumId}/tracks?limit=${limit}&offset=${offset}`,
                    'GET'
                );
                tracks.push(...data.items);
                
                if (data.items.length < limit) break;
                offset += limit;
            }
            
            return tracks;
        }

        function isVariation(trackName) {
            const variations = /live|acoustic|remix|remaster|demo|instrumental|radio edit|extended|version/i;
            return variations.test(trackName);
        }

        function normalizeTrackName(name) {
            return name
                .toLowerCase()
                .replace(/\s*[\(\[].*?[\)\]]\s*/g, '')
                .replace(/[^\w\s]/g, '')
                .trim();
        }

        async function getUniqueArtistTracks(artistIds) {
            const trackMap = new Map();
            
            for (const artistId of artistIds) {
                updateStatus(`Fetching albums for artist...`, 'info');
                const albums = await getArtistAlbums(artistId);
                
                for (let i = 0; i < albums.length; i++) {
                    const album = albums[i];
                    updateStatus(`Fetching tracks from ${album.name} (${i+1}/${albums.length})...`, 'info');
                    const tracks = await getAlbumTracks(album.id);
                    
                    for (const track of tracks) {
                        const normalized = normalizeTrackName(track.name);
                        const isVar = isVariation(track.name);
                        const key = `${normalized}_${isVar ? track.name : 'standard'}`;
                        
                        if (!trackMap.has(key)) {
                            trackMap.set(key, track);
                        }
                    }
                }
            }
            
            return Array.from(trackMap.values());
        }

        async function createPlaylist() {
            const artistInput = document.getElementById('artistName').value;
            const playlistName = document.getElementById('playlistName').value;

            if (!artistInput || !playlistName) {
                updateStatus('❌ Please enter both artist names and playlist name', 'error');
                return;
            }

            // Parse multiple artist names (split by newlines and commas)
            const artistNames = artistInput
                .split(/[\n,]+/)
                .map(name => name.trim())
                .filter(name => name.length > 0);

            if (artistNames.length === 0) {
                updateStatus('❌ Please enter at least one artist name', 'error');
                return;
            }

            document.getElementById('createBtn').disabled = true;

            try {
                // Search for all artists
                const artists = [];
                const artistNamesFound = [];

                for (const artistName of artistNames) {
                    updateStatus(`Searching for ${artistName}...`, 'info');
                    const artist = await searchArtist(artistName);

                    if (!artist) {
                        updateStatus(`⚠️ Artist "${artistName}" not found, skipping...`, 'error');
                        continue;
                    }

                    updateStatus(`Found: ${artist.name}`, 'info');
                    artists.push(artist);
                    artistNamesFound.push(artist.name);
                }

                if (artists.length === 0) {
                    updateStatus('❌ No artists found', 'error');
                    document.getElementById('createBtn').disabled = false;
                    return;
                }

                const user = await fetchWebApi('v1/me', 'GET');

                const artistList = artistNamesFound.join(', ');
                const playlist = await fetchWebApi(
                    `v1/users/${user.id}/playlists`,
                    'POST',
                    {
                        name: playlistName,
                        description: `Complete discography: ${artistList} - with smart deduplication`,
                        public: false
                    }
                );

                updateStatus(`Created playlist: ${playlist.name}`, 'info');

                const artistIds = artists.map(a => a.id);
                const tracks = await getUniqueArtistTracks(artistIds);
                updateStatus(`Found ${tracks.length} unique tracks from ${artists.length} artist(s). Adding to playlist...`, 'info');

                const trackUris = tracks.map(t => t.uri);
                for (let i = 0; i < trackUris.length; i += 100) {
                    const batch = trackUris.slice(i, i + 100);
                    await fetchWebApi(
                        `v1/playlists/${playlist.id}/tracks`,
                        'POST',
                        { uris: batch }
                    );
                    updateStatus(`Added tracks ${i + 1}-${Math.min(i + 100, trackUris.length)} of ${tracks.length}`, 'info');
                }

                updateStatus(`✅ Success! <a href="${playlist.external_urls.spotify}" target="_blank" style="color: #1db954;">Open Playlist</a>`, 'success');

            } catch (error) {
                updateStatus('❌ Error: ' + error.message, 'error');
                console.error(error);
            } finally {
                document.getElementById('createBtn').disabled = false;
            }
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = type;
        }
    </script>
</body>
</html>

